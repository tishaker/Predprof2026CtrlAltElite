{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">üìã –ö–æ–Ω–∫—É—Ä—Å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h2>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">–ü—Ä–æ–≥—Ä–∞–º–º–∞:</label>
                <select name="program" class="form-select" id="program-select">
                    <option value="all">–í—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</option>
                    {% for prog in programs %}
                    <option value="{{ prog }}" {% if current_program == prog %}selected{% endif %}>{{ prog }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">–î–∞—Ç–∞:</label>
                <select name="date" class="form-select" id="date-select">
                    <option value="all">–í—Å–µ –¥–∞—Ç—ã</option>
                    {% for d in dates %}
                    <option value="{{ d }}" {% if current_date == d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                <select name="sort_by" class="form-select" id="sort-select">
                    <option value="total" {% if request.args.get('sort_by') == 'total' %}selected{% endif %}>–ü–æ –±–∞–ª–ª–∞–º</option>
                    <option value="id" {% if request.args.get('sort_by') == 'id' %}selected{% endif %}>–ü–æ ID</option>
                    <option value="priority" {% if request.args.get('sort_by') == 'priority' %}selected{% endif %}>–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">–ü–æ—Ä—è–¥–æ–∫:</label>
                <select name="order" class="form-select" id="order-select">
                    <option value="desc" {% if request.args.get('order') == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    <option value="asc" {% if request.args.get('order') == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                </select>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø—Ä–æ—Ö–æ–¥–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">üéØ –ü—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã –Ω–∞ –û–ü</h5>
            </div>
            <div class="card-body">
                <div class="row" id="passing-scores-container">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ö–æ–¥–Ω—ã—Ö –±–∞–ª–ª–∞—Ö...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ</small>
            </div>
        </div>
    </div>
</div>

<!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å–∫–∞–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">üîÑ –ö–∞—Å–∫–∞–¥ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="cascadeChart" height="250"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="list-group">
                            <div class="list-group-item">
                                <small class="text-muted">–í—Å–µ–≥–æ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º</small>
                                <h5 id="total-with-consent" class="mb-0">0</h5>
                            </div>
                            <div class="list-group-item">
                                <small class="text-muted">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤</small>
                                <h5 id="showing-cascade" class="mb-0">0</h5>
                            </div>
                            <div class="list-group-item">
                                <small class="text-muted">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤</small>
                                <h5 id="avg-priorities" class="mb-0">0</h5>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-accepted" checked>
                                <label class="form-check-label" for="show-accepted">
                                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">
                                –ó–µ–ª–µ–Ω—ã–º –≤—ã–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –ø–æ –±–∞–ª–ª–∞–º
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="distributionChart" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="list-group">
                            <div class="list-group-item">
                                <small class="text-muted">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</small>
                                <h5 id="total-count" class="mb-0">0</h5>
                            </div>
                            <div class="list-group-item">
                                <small class="text-muted">–ê–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º</small>
                                <h5 id="with-consent-count" class="mb-0">0</h5>
                            </div>
                            <div class="list-group-item">
                                <small class="text-muted">–ü—Ä–æ—Ü–µ–Ω—Ç —Å —Å–æ–≥–ª–∞—Å–∏–µ–º</small>
                                <h5 id="consent-percent" class="mb-0">0%</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–∫—É—Ä—Å–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">üìã –ö–æ–Ω–∫—É—Ä—Å–Ω—ã–π —Å–ø–∏—Å–æ–∫</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th width="80">
                            <a href="?sort_by=id&order={% if request.args.get('sort_by') == 'id' and request.args.get('order') == 'asc' %}desc{% else %}asc{% endif %}&program={{ current_program }}&date={{ current_date }}">
                                ID
                            </a>
                        </th>
                        <th>–ü—Ä–æ–≥—Ä–∞–º–º–∞</th>
                        <th width="100">–î–∞—Ç–∞</th>
                        <th width="100">
                            <a href="?sort_by=priority&order={% if request.args.get('sort_by') == 'priority' and request.args.get('order') == 'asc' %}desc{% else %}asc{% endif %}&program={{ current_program }}&date={{ current_date }}">
                                –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                            </a>
                        </th>
                        <th width="100">–°–æ–≥–ª–∞—Å–∏–µ</th>
                        <th width="100">–§–∏–∑–∏–∫–∞</th>
                        <th width="100">–†—É—Å—Å–∫–∏–π</th>
                        <th width="100">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</th>
                        <th width="120">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</th>
                        <th width="100">
                            <a href="?sort_by=total&order={% if request.args.get('sort_by') == 'total' and request.args.get('order') == 'desc' %}asc{% else %}desc{% endif %}&program={{ current_program }}&date={{ current_date }}">
                                –°—É–º–º–∞
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in applicants %}
                    <tr class="{% if app.consent %}table-success{% endif %}">
                        <td>
                            <span class="badge bg-secondary">{{ app.applicant_id }}</span>
                        </td>
                        <td>
                            <span class="badge
                                {% if app.program == '–ü–ú' %}bg-primary
                                {% elif app.program == '–ò–í–¢' %}bg-info
                                {% elif app.program == '–ò–¢–°–°' %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ app.program }}
                            </span>
                        </td>
                        <td>{{ app.date }}</td>
                        <td>
                            <span class="badge
                                {% if app.priority == 1 %}bg-danger
                                {% elif app.priority == 2 %}bg-warning
                                {% elif app.priority == 3 %}bg-primary
                                {% else %}bg-secondary{% endif %}">
                                {{ app.priority }}
                            </span>
                        </td>
                        <td>
                            {% if app.consent %}
                            <span class="badge bg-success">‚úì –î–∞</span>
                            {% else %}
                            <span class="badge bg-secondary">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                        <td>{{ app.physics }}</td>
                        <td>{{ app.russian }}</td>
                        <td>{{ app.math }}</td>
                        <td>{{ app.achievements }}</td>
                        <td>
                            <strong class="{% if app.consent %}text-success{% endif %}">
                                {{ app.total }}
                            </strong>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ: {{ applicants|length }} –∑–∞–ø–∏—Å–µ–π</span>
            <small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ now|default("—Å–µ–≥–æ–¥–Ω—è") }}</small>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 20px;
}

.list-group-item {
    border: none;
    padding: 0.75rem 1.25rem;
}

.list-group-item small {
    font-size: 0.8rem;
}

.table th a {
    text-decoration: none;
    color: white;
}

.table th a:hover {
    text-decoration: underline;
}

.badge {
    font-size: 0.8em;
    padding: 0.4em 0.6em;
}

.passing-score-card {
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

.passing-score-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.passing-badge {
    font-size: 1.2em;
    padding: 0.5em 1em;
}

.cascade-bar {
    transition: all 0.3s ease;
    cursor: pointer;
}

.cascade-bar:hover {
    opacity: 0.8;
}
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
let cascadeChart = null;
let distributionChart = null;

// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
const programSeats = {
    '–ü–ú': 40,
    '–ò–í–¢': 50,
    '–ò–¢–°–°': 30,
    '–ò–ë': 20
};

// –¶–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º
const programColors = {
    '–ü–ú': 'rgba(13, 110, 253, 0.8)',
    '–ò–í–¢': 'rgba(13, 202, 240, 0.8)',
    '–ò–¢–°–°': 'rgba(255, 193, 7, 0.8)',
    '–ò–ë': 'rgba(220, 53, 69, 0.8)'
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ö–æ–¥–Ω—ã—Ö –±–∞–ª–ª–∞—Ö
function loadPassingScores() {
    const date = document.getElementById('date-select').value;
    const url = `/passing_scores?date=${date}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            updatePassingScores(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ö–æ–¥–Ω—ã—Ö –±–∞–ª–ª–æ–≤:', error);
            document.getElementById('passing-scores-container').innerHTML =
                '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥–Ω—ã—Ö –±–∞–ª–ª–æ–≤
function updatePassingScores(data) {
    const container = document.getElementById('passing-scores-container');
    let html = '';

    for (const [program, info] of Object.entries(data)) {
        const passingScore = info.passing_score === '–ù–ï–î–û–ë–û–†' ?
            '<span class="badge bg-warning passing-badge">–ù–ï–î–û–ë–û–†</span>' :
            `<span class="badge bg-danger passing-badge">${info.passing_score}</span>`;

        html += `
            <div class="col-md-3 mb-3">
                <div class="card passing-score-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">${program}</h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>–ú–µ—Å—Ç:</span>
                            <span class="badge bg-primary">${info.seats}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>–ü–æ–¥–∞–Ω–æ –∑–∞—è–≤–ª–µ–Ω–∏–π:</span>
                            <span class="badge bg-info">${info.total_applicants}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª:</span>
                            ${passingScore}
                        </div>
                        <div class="small text-muted">
                            –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
                            ${[1,2,3,4].map(p =>
                                `<span class="badge bg-secondary me-1">${p}: ${info.priorities[p].count}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Å–∫–∞–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
function loadCascadeData() {
    const program = document.getElementById('program-select').value;
    const date = document.getElementById('date-select').value;
    const url = `/priority_cascade?program=${program}&date=${date}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            updateCascadeChart(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Å–∫–∞–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞—Å–∫–∞–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
function updateCascadeChart(data) {
    const ctx = document.getElementById('cascadeChart').getContext('2d');

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫
    if (cascadeChart) {
        cascadeChart.destroy();
    }

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const maxApplicants = 20;
    const cascadeData = data.cascade.slice(0, maxApplicants);

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const labels = cascadeData.map(d => `–ê–±. ${d.id}`);
    const datasets = [];

    // –°–æ–∑–¥–∞–µ–º dataset –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    for (let priority = 1; priority <= 4; priority++) {
        const scores = cascadeData.map(d => {
            const priorityData = d.priorities.find(p => p.priority === priority);
            return priorityData ? priorityData.score : null;
        });

        datasets.push({
            label: `–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${priority}`,
            data: scores,
            backgroundColor: priority === 1 ? 'rgba(220, 53, 69, 0.7)' :
                          priority === 2 ? 'rgba(255, 193, 7, 0.7)' :
                          priority === 3 ? 'rgba(13, 110, 253, 0.7)' :
                                          'rgba(108, 117, 125, 0.7)',
            borderColor: priority === 1 ? 'rgba(220, 53, 69, 1)' :
                         priority === 2 ? 'rgba(255, 193, 7, 1)' :
                         priority === 3 ? 'rgba(13, 110, 253, 1)' :
                                         'rgba(108, 117, 125, 1)',
            borderWidth: 1,
            hidden: priority > 2 // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 1-2 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
        });
    }

    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    cascadeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: '–ê–±–∏—Ç—É—Ä–∏–µ–Ω—Ç—ã'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: '–ë–∞–ª–ª—ã'
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} –±–∞–ª–ª–æ–≤`;
                        }
                    }
                }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('total-with-consent').textContent = data.total_applicants;
    document.getElementById('showing-cascade').textContent = cascadeData.length;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
    const avgPriorities = cascadeData.length > 0 ?
        (cascadeData.reduce((sum, d) => sum + d.priorities.length, 0) / cascadeData.length).toFixed(1) : 0;
    document.getElementById('avg-priorities').textContent = avgPriorities;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
function loadDistributionData() {
    const program = document.getElementById('program-select').value;
    const date = document.getElementById('date-select').value;
    const url = `/chart_data?program=${program}&date=${date}&consent=all`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            updateDistributionChart(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
function updateDistributionChart(data) {
    const ctx = document.getElementById('distributionChart').getContext('2d');

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫
    if (distributionChart) {
        distributionChart.destroy();
    }

    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    distributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤',
                data: data.data,
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '–î–∏–∞–ø–∞–∑–æ–Ω –±–∞–ª–ª–æ–≤'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('total-count').textContent = data.count;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ–≥–ª–∞—Å–∏—è—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
    const consentUrl = `/chart_data?program=${program}&date=${date}&consent=yes`;
    fetch(consentUrl)
        .then(response => response.json())
        .then(consentData => {
            document.getElementById('with-consent-count').textContent = consentData.count;
            const percent = data.count > 0 ? Math.round((consentData.count / data.count) * 100) : 0;
            document.getElementById('consent-percent').textContent = percent + '%';
        });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initializeCharts() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
    const startTime = Date.now();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    Promise.all([
        loadPassingScores(),
        loadCascadeData(),
        loadDistributionData()
    ]).then(() => {
        const endTime = Date.now();
        const loadTime = endTime - startTime;
        console.log(`–ì—Ä–∞—Ñ–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞ ${loadTime}ms`);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        if (loadTime > 3000) {
            console.warn(`–í–Ω–∏–º–∞–Ω–∏–µ: –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (${loadTime}ms) –ø—Ä–µ–≤—ã—à–∞–µ—Ç 3 —Å–µ–∫—É–Ω–¥—ã`);
        }
    }).catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    initializeCharts();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('program-select').addEventListener('change', function() {
        initializeCharts();
    });

    document.getElementById('date-select').addEventListener('change', function() {
        initializeCharts();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(initializeCharts, 30000);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞
    document.getElementById('show-accepted').addEventListener('change', function() {
        if (cascadeChart) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
function measurePerformance(fn) {
    const start = performance.now();
    const result = fn();
    const end = performance.now();
    return {
        result,
        time: end - start
    };
}
</script>

{% endblock %}